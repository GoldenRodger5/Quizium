<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS PWA Optimization -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Quizium">
    <meta name="apple-touch-fullscreen" content="yes">
    
    <!-- Theme and Colors -->
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-navbutton-color" content="#667eea">
    
    <!-- SEO and Description -->
    <meta name="description" content="Quizium - AI-powered flashcard generator and study assistant">
    <meta name="keywords" content="flashcards, study, AI, education, learning, Quizium">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/static/icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/static/icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="/static/icons/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    
    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
    
    <title>Quizium - AI Flashcard Study App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* iOS Safe Area Support for Dynamic Island */
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-right: env(safe-area-inset-right);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding-bottom: 20px;
            /* iOS Safe Area Support */
            padding-top: var(--safe-area-inset-top);
            padding-left: var(--safe-area-inset-left);
            padding-right: var(--safe-area-inset-right);
            padding-bottom: calc(20px + var(--safe-area-inset-bottom));
        }

        /* PWA iOS Optimization */
        @supports (-webkit-touch-callout: none) {
            body {
                /* Additional padding for iOS devices */
                padding-top: max(var(--safe-area-inset-top), 20px);
            }
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 15px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2.2em;
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            padding: 0 10px;
        }

        /* Mobile Tab Navigation */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-nav {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            color: #4a5568;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Study Session UI */
        .study-session {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
        }

        .study-progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            height: 8px;
            margin: 16px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: white;
            height: 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 16px;
            padding: 24px;
            margin: 16px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .answer-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 16px;
            transition: border-color 0.3s ease;
        }

        .answer-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .btn-hint {
            background: #fbb6ce;
            color: #97266d;
        }

        .btn-hint:hover {
            background: #f687b3;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
        }

        .footer a:hover {
            color: white;
        }

        /* Filter styles */
        .filter-select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        .filter-select:focus {
            border-color: #667eea;
            outline: none;
        }

        h2 {
            color: #4a5568;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 25px 15px;
            text-align: center;
            background: #f7fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e6fffa;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
            margin: 8px 5px;
            min-width: 120px;
        }

        .upload-btn:hover {
            background: #5a67d8;
        }

        .btn {
            background: #48bb78;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
            margin: 5px;
            min-width: 100px;
        }

        .btn:hover {
            background: #38a169;
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #ed8936;
        }

        .btn-secondary:hover {
            background: #dd6b20;
        }

        .btn-hint {
            background: #805ad5;
        }

        .btn-hint:hover {
            background: #6b46c1;
        }

        .hidden {
            display: none;
        }

        .question-info {
            background: #e6fffa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #38b2ac;
            font-size: 14px;
        }

        .question-text {
            font-size: 1.1em;
            margin: 15px 0;
            color: #2d3748;
            line-height: 1.4;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            margin: 12px 0;
            transition: border-color 0.3s ease;
            resize: vertical;
            min-height: 80px;
        }

        .answer-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .result {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-weight: bold;
            font-size: 14px;
        }

        .result.correct {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #68d391;
        }

        .result.incorrect {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #fc8181;
        }

        .score {
            text-align: center;
            font-size: 1.1em;
            margin: 15px 0;
            color: #4a5568;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: #48bb78;
            transition: width 0.3s ease;
        }

        .hint {
            background: #fef5e7;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #ed8936;
            color: #744210;
            font-size: 14px;
        }

        .final-score {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            margin: 15px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }

        /* Flashcard Styles - Mobile Optimized */
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            background: #f7fafc;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: #f7fafc;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            text-align: center;
        }

        .tab-button.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .tab-button:hover {
            background: #edf2f7;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .flashcard-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            flex: 0 0 auto;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .flashcard-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            perspective: 1000px;
        }

        .flashcard {
            width: 100%;
            max-width: 400px;
            height: 250px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .flashcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .card-type {
            font-size: 12px;
            font-weight: bold;
            opacity: 0.8;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-content {
            font-size: 16px;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-y: auto;
            max-height: 180px;
        }

        .flashcard-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        #cardCounter {
            font-size: 14px;
            font-weight: bold;
            color: #4a5568;
            flex: 1;
            text-align: center;
            min-width: 80px;
        }

        /* URL Input Section - Mobile Optimized */
        .url-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .url-input-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        #urlInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            min-width: 0;
        }

        .url-examples {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
            padding: 8px;
            background: #f7fafc;
            border-radius: 6px;
        }

        /* Study Mode Controls */
        .study-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
        }

        .study-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .study-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #studyNumQuestions {
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            width: 80px;
            text-align: center;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
                margin: 10px 0;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }

            h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }

            .tab-btn {
                font-size: 12px;
                padding: 10px 6px;
            }
            
            .question-card {
                padding: 20px;
                min-height: 180px;
            }
            
            .question-text {
                font-size: 16px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                min-width: 100%;
                margin-bottom: 8px;
            }

            .upload-area {
                padding: 20px 10px;
            }
            
            /* Mobile-specific notification positioning */
            #globalMessage {
                top: max(90px, calc(var(--safe-area-inset-top) + 70px)) !important;
                right: 10px !important;
                left: 10px !important;
                max-width: none !important;
                min-width: auto !important;
            }

            .upload-area p {
                font-size: 14px !important;
                margin-bottom: 10px !important;
            }

            .btn, .upload-btn {
                padding: 8px 12px;
                font-size: 13px;
                margin: 3px;
                min-width: 90px;
            }

            .tab-button {
                padding: 10px 6px;
                font-size: 13px;
            }

            .flashcard {
                height: 200px;
                max-width: 100%;
            }

            .flashcard-front,
            .flashcard-back {
                padding: 15px;
            }

            .card-content {
                font-size: 14px;
                max-height: 140px;
            }

            .card-type {
                font-size: 11px;
                margin-bottom: 8px;
            }

            .nav-btn {
                padding: 6px 8px;
                font-size: 11px;
            }

            #cardCounter {
                font-size: 13px;
            }

            .answer-input {
                padding: 10px;
                font-size: 16px;
                min-height: 60px;
            }

            .url-input-row {
                flex-direction: column;
            }

            .url-examples {
                font-size: 12px;
            }

            .study-input-row {
                flex-direction: column;
                text-align: center;
            }

            .flashcard-controls {
                gap: 5px;
            }

            .study-controls {
                gap: 5px;
            }
            
            .progress-info {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .card {
                padding: 12px;
                margin: 8px 0;
            }

            h1 {
                font-size: 1.6em;
                margin-bottom: 15px;
            }

            h2 {
                font-size: 1.2em;
                margin-bottom: 12px;
            }
            
            .tab-btn {
                font-size: 11px;
                padding: 8px 4px;
            }
            
            .question-card {
                padding: 16px;
                min-height: 160px;
            }
            
            .question-text {
                font-size: 15px;
            }

            .flashcard {
                height: 180px;
            }

            .flashcard-front,
            .flashcard-back {
                padding: 12px;
            }

            .card-content {
                font-size: 13px;
                max-height: 120px;
            }

            .flashcard-navigation {
                padding: 0 5px;
            }

            .nav-btn {
                padding: 5px 6px;
                font-size: 10px;
            }

            #cardCounter {
                font-size: 12px;
            }
            
            /* Small mobile notification positioning */
            #globalMessage {
                top: max(100px, calc(var(--safe-area-inset-top) + 80px)) !important;
                right: 8px !important;
                left: 8px !important;
                font-size: 14px !important;
                padding: 12px 16px !important;
            }

            .btn, .upload-btn {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 80px;
            }

            .tab-button {
                padding: 8px 4px;
                font-size: 12px;
            }

            .question-text {
                font-size: 15px;
            }

            .answer-input {
                font-size: 16px; /* Keep 16px to prevent zoom on iOS */
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>üß† Quizium</h1>
            <button class="btn btn-secondary" onclick="restartApp()" style="background: #e53e3e; color: white;">
                üîÑ Restart App
            </button>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('generate')">Generate</button>
                <button class="tab-btn" onclick="showTab('flashcards')">Flashcards</button>
                <button class="tab-btn" onclick="showTab('study')">Study</button>
                <button class="tab-btn" onclick="showTab('training')">Training Assistant</button>
            </div>
        </div>

        <!-- Generate Tab -->
        <div id="generateTab" class="tab-content active">
            <!-- File Upload Section -->
            <div class="card">
                <h2>üìÑ Upload Study Material</h2>
                <div class="upload-area" id="uploadArea">
                    <p style="margin-bottom: 15px; font-size: 1.1em;">Drag and drop your file here, or click to browse</p>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Supported: PDF, DOC, DOCX (generate flashcards) or JSON (existing flashcards)</p>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.json">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                </div>
                <div id="uploadResult" class="hidden"></div>
            </div>

            <!-- URL Input Section -->
            <div class="card">
                <h2>üåê Generate from Web Content</h2>
                <div class="url-input-container">
                    <p style="margin-bottom: 15px; font-size: 1.1em; text-align: center;">
                        Enter a URL to generate flashcards from web content
                    </p>
                    <p style="color: #666; margin-bottom: 15px; text-align: center; font-size: 14px;">
                        Supported: Wikipedia articles, web articles, blog posts
                    </p>
                    <div class="url-input-row">
                        <input type="url" id="urlInput" placeholder="https://en.wikipedia.org/wiki/Machine_Learning" 
                               style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                        <button class="upload-btn" onclick="processURL()" id="urlBtn">
                            Generate
                        </button>
                    </div>
                    <div class="url-examples">
                        <strong>Examples:</strong><br>
                        ‚Ä¢ https://en.wikipedia.org/wiki/Artificial_Intelligence<br>
                        ‚Ä¢ Any article or blog post URL
                    </div>
                </div>
                <div id="urlResult" class="hidden"></div>
            </div>
        </div>

        <!-- Flashcards Tab -->
        <div id="flashcardsTab" class="tab-content">
            <!-- Flashcard Browse Section -->
            <div class="card">
                <h2>üìö Browse Your Flashcards</h2>
                
                <!-- Filters Section -->
                <div id="filtersSection" class="hidden" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px;">Filter Flashcards</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <label for="categoryFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Category:</label>
                            <select id="categoryFilter" class="filter-select" onchange="applyFilters()">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                        <div>
                            <label for="difficultyFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Difficulty:</label>
                            <select id="difficultyFilter" class="filter-select" onchange="applyFilters()">
                                <option value="all">All Difficulties</option>
                            </select>
                        </div>
                        <div>
                            <label for="typeFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Type:</label>
                            <select id="typeFilter" class="filter-select" onchange="applyFilters()">
                                <option value="all">All Types</option>
                            </select>
                        </div>
                    </div>
                    <div id="filterResults" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                </div>

                <div class="flashcard-navigation">
                    <button class="nav-btn" onclick="previousCard()" id="prevBtn">‚Üê Previous</button>
                    <span id="cardCounter">1 / 10</span>
                    <button class="nav-btn" onclick="nextCard()" id="nextBtn">Next ‚Üí</button>
                </div>
                
                <div class="flashcard-container">
                    <div class="flashcard" id="currentFlashcard" onclick="flipCard()">
                        <div class="flashcard-front" id="cardFront">
                            <div class="card-type" id="cardType">Question</div>
                            <div class="card-content" id="cardQuestion">Generate flashcards first to browse them</div>
                        </div>
                        <div class="flashcard-back" id="cardBack">
                            <div class="card-type">Answer</div>
                            <div class="card-content" id="cardAnswer">Answer will appear here</div>
                        </div>
                    </div>
                </div>
                
                <div class="flashcard-controls">
                    <button class="btn btn-secondary" onclick="flipCard()">Flip Card</button>
                    <button class="btn" onclick="shuffleFlashcards()">Shuffle</button>
                    <button class="btn" onclick="showTab('study')">Start Study Session</button>
                </div>
            </div>
        </div>

        <!-- Study Tab -->
        <div id="studyTab" class="tab-content">
            <!-- Setup Section -->
            <div id="setupSection" class="card">
                <h2>‚öôÔ∏è Study Setup</h2>
                <div id="flashcardInfo"></div>
                
                <!-- Filters Section -->
                <div id="studyFiltersSection" class="hidden" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px;">Filter Questions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <label for="studyCategoryFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Category:</label>
                            <select id="studyCategoryFilter" class="filter-select" onchange="applyStudyFilters()">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                        <div>
                            <label for="studyDifficultyFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Difficulty:</label>
                            <select id="studyDifficultyFilter" class="filter-select" onchange="applyStudyFilters()">
                                <option value="all">All Difficulties</option>
                            </select>
                        </div>
                        <div>
                            <label for="studyTypeFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Type:</label>
                            <select id="studyTypeFilter" class="filter-select" onchange="applyStudyFilters()">
                                <option value="all">All Types</option>
                            </select>
                        </div>
                    </div>
                    <div id="studyFilterResults" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                </div>
                
                <div id="studyQuestionControls" style="text-align: center; margin: 20px 0;">
                    <label for="numQuestions" style="display: block; margin-bottom: 10px; font-weight: bold;">How many questions do you want to answer?</label>
                    <input type="number" id="numQuestions" min="1" value="10" 
                           style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; width: 100px; text-align: center;">
                </div>
                <div id="studyStartButton" style="text-align: center;">
                    <button class="btn" onclick="startStudySession()">Start Study Session</button>
                </div>
            </div>

            <!-- Study Session Section -->
            <div id="studySessionSection" class="study-session hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: white; margin-bottom: 10px;">üéØ Study Session</h2>
                    <div class="progress-info" style="color: rgba(255,255,255,0.9); font-size: 16px;">
                        Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">10</span>
                    </div>
                    <div class="study-progress">
                        <div class="progress-bar" id="progressBar" style="width: 10%"></div>
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-text" id="currentQuestion">Loading question...</div>
                    <input type="text" id="answerInput" class="answer-input" placeholder="Type your answer here..." autocomplete="off">
                    <div class="action-buttons">
                        <button class="action-btn btn-primary" onclick="submitAnswer()">Submit Answer</button>
                        <button class="action-btn btn-hint" onclick="getHint()">Hint</button>
                        <button class="action-btn btn-secondary" onclick="skipQuestion()">Skip</button>
                    </div>
                </div>

                <div id="answerFeedback" class="hidden"></div>
                <div id="hintContainer" class="hidden"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="action-btn btn-secondary" onclick="endStudySession()">End Session</button>
                </div>
            </div>

            <!-- Study Results Section -->
            <div id="studyResultsSection" class="card hidden">
                <h2>üìä Study Results</h2>
                <div id="studyResults"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="startNewStudySession()">Start New Session</button>
                    <button class="btn" onclick="showTab('flashcards')">Browse Flashcards</button>
                </div>
            </div>
        </div>

        <!-- Training Assistant Tab -->
        <div id="trainingTab" class="tab-content">
            <div class="card">
                <h2>ü§ñ Training Assistant</h2>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <h3>Coming Soon!</h3>
                    <p>The Training Assistant feature is under development.</p>
                    <p>This will provide personalized AI coaching based on your study performance.</p>
                </div>
            </div>
        </div>

        <!-- Final Results Section -->
        <div id="resultsSection" class="card hidden">
            <div id="finalResults"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="startOver()">Start Over</button>
            </div>
        </div>

        <!-- Loading Section -->
        <div id="loadingSection" class="card hidden">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Processing your file...</p>
            </div>
        </div>
        
    </div> <!-- Close container -->

    <script>
        let currentSessionId = null;
        let currentStudySessionId = null;
        let currentQuestionData = null;
        let currentFlashcards = []; // Store original flashcards
        let filteredFlashcards = []; // Store filtered flashcards
        let currentFilters = { category: 'all', difficulty: 'all', type: 'all' };
        let showingResult = false;
        let studySessionActive = false;
        let studySessionComplete = false;
        let studyResults = null;

        // Global Variables
        let currentQuestionIndex = 0;
        let correctAnswers = 0;
        let totalQuestions = 0;
        let currentCardIndex = 0;
        
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        // PWA Variables
        let deferredPrompt;

        // Utility Functions
        function showMessage(message, type = 'info') {
            // Create message element if it doesn't exist
            let messageEl = document.getElementById('globalMessage');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'globalMessage';
                messageEl.style.cssText = `
                    position: fixed;
                    top: max(70px, calc(var(--safe-area-inset-top) + 50px));
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    font-weight: bold;
                    z-index: 10000;
                    min-width: 250px;
                    max-width: 400px;
                    word-wrap: break-word;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                `;
                document.body.appendChild(messageEl);
            }
            
            // Style based on type
            const styles = {
                success: { background: '#38a169', color: 'white', border: '2px solid #2f855a' },
                error: { background: '#e53e3e', color: 'white', border: '2px solid #c53030' },
                warning: { background: '#d69e2e', color: 'white', border: '2px solid #b7791f' },
                info: { background: '#3182ce', color: 'white', border: '2px solid #2c5aa0' }
            };
            
            const style = styles[type] || styles.info;
            Object.assign(messageEl.style, style);
            messageEl.textContent = message;
            
            // Show message
            setTimeout(() => {
                messageEl.style.transform = 'translateX(0)';
            }, 100);
            
            // Hide message after 4 seconds
            setTimeout(() => {
                messageEl.style.transform = 'translateX(100%)';
            }, 4000);
        }

        function showTab(tabName) {
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked tab button
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            const tabId = tabName + 'Tab';
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Special handling for flashcards tab
            if (tabName === 'flashcards' && currentFlashcards && currentFlashcards.length > 0) {
                loadFilters();
                updateFlashcard();
            }
            
            // Special handling for study tab
            if (tabName === 'study') {
                if (currentFlashcards && currentFlashcards.length > 0) {
                    showSetupSection(currentFlashcards.length);
                } else {
                    // Show message when no flashcards are available
                    const flashcardInfo = document.getElementById('flashcardInfo');
                    if (flashcardInfo) {
                        flashcardInfo.innerHTML = `
                            <div style="text-align: center; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin-bottom: 20px;">
                                <span style="font-size: 24px;">üìö</span><br>
                                <strong>No flashcards available</strong><br>
                                <span style="color: #856404;">Please generate flashcards first by uploading a file or entering a URL.</span>
                            </div>
                        `;
                    }
                    
                    // Hide study controls when no flashcards
                    const studyFiltersSection = document.getElementById('studyFiltersSection');
                    const studyQuestionControls = document.getElementById('studyQuestionControls');
                    const studyStartButton = document.getElementById('studyStartButton');
                    
                    if (studyFiltersSection) studyFiltersSection.classList.add('hidden');
                    if (studyQuestionControls) studyQuestionControls.style.display = 'none';
                    if (studyStartButton) studyStartButton.style.display = 'none';
                    
                    // Show setup section but hide session sections
                    const setupSection = document.getElementById('setupSection');
                    if (setupSection) {
                        setupSection.classList.remove('hidden');
                    }
                    document.getElementById('studySessionSection').classList.add('hidden');
                    document.getElementById('studyResultsSection').classList.add('hidden');
                }
            }
        }

        function showUploadSuccess(result) {
            const uploadResult = document.getElementById('uploadResult');
            uploadResult.innerHTML = `
                <div class="success-message">
                    <h3>‚úÖ Upload Successful!</h3>
                    <p>Generated <strong>${result.flashcard_count}</strong> flashcards</p>
                    <p>You can now start studying or browse your flashcards</p>
                </div>
            `;
            uploadResult.classList.remove('hidden');
            showMessage(`Successfully generated ${result.flashcard_count} flashcards!`, 'success');
        }

        function showUploadError(error) {
            const uploadResult = document.getElementById('uploadResult');
            uploadResult.innerHTML = `
                <div class="error-message">
                    <h3>‚ùå Upload Failed</h3>
                    <p>${error}</p>
                </div>
            `;
            uploadResult.classList.remove('hidden');
            showMessage('Upload failed: ' + error, 'error');
        }

        function showSetupSection(flashcardCount) {
            // Load filters for the flashcards
            loadFilters();
            
            document.getElementById('flashcardInfo').innerHTML = `
                <div class="flashcard-stats">
                    <h3>üìö Ready to Study!</h3>
                    <p>You have <strong>${flashcardCount}</strong> flashcards available</p>
                </div>
            `;
            
            // Update max questions - this should always be based on the full set of flashcards,
            // not any filtered subset. Study sessions use all available flashcards.
            const numQuestionsInput = document.getElementById('numQuestions');
            numQuestionsInput.max = flashcardCount;
            numQuestionsInput.value = Math.min(10, flashcardCount);
            
            // Show study controls when flashcards are available
            const studyFiltersSection = document.getElementById('studyFiltersSection');
            const studyQuestionControls = document.getElementById('studyQuestionControls');
            const studyStartButton = document.getElementById('studyStartButton');
            
            if (studyFiltersSection) studyFiltersSection.classList.remove('hidden');
            if (studyQuestionControls) studyQuestionControls.style.display = '';
            if (studyStartButton) studyStartButton.style.display = '';
            
            // Show the setup section within the study tab
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('studySessionSection').classList.add('hidden');
            document.getElementById('studyResultsSection').classList.add('hidden');
        }

        function shuffleFlashcards() {
            if (!currentFlashcards || currentFlashcards.length === 0) {
                showMessage('No flashcards to shuffle', 'warning');
                return;
            }
            
            // Fisher-Yates shuffle algorithm
            for (let i = currentFlashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentFlashcards[i], currentFlashcards[j]] = [currentFlashcards[j], currentFlashcards[i]];
            }
            
            // Reset to first card and update display
            currentCardIndex = 0;
            updateFlashcard();
            showMessage('Flashcards shuffled!', 'success');
        }

        // Utility function to safely get elements
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }

        // Error handling wrapper
        function safeExecute(fn, errorMessage = 'An error occurred') {
            try {
                return fn();
            } catch (error) {
                console.error(errorMessage, error);
                showMessage(errorMessage, 'error');
                return null;
            }
        }

        // Initialize event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize upload functionality
            if (uploadArea && fileInput) {
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFile(files[0]);
                    }
                });

                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFile(e.target.files[0]);
                    }
                });
            }

            // Initialize answer input event listener
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                answerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        submitAnswer();
                    }
                });
            }

            // Initialize PWA
            initializePWA();
            
            // URL input Enter key support
            const urlInput = document.getElementById('urlInput');
            if (urlInput) {
                urlInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        processURL();
                    }
                });
            }
        });

        async function handleFile(file) {
            // Prevent multiple simultaneous uploads
            if (document.getElementById('fileInput').disabled) {
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Disable file input to prevent multiple uploads
            document.getElementById('fileInput').disabled = true;
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.style.pointerEvents = 'none';
                uploadArea.style.opacity = '0.6';
            }

            showSection('loadingSection');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    currentSessionId = result.session_id;
                    currentFlashcards = result.flashcards || []; // Store flashcards from upload
                    
                    // Reset any active study session since we have new flashcards
                    currentStudySessionId = null;
                    studySessionActive = false;
                    studySessionComplete = false;
                    studyResults = null;
                    showingResult = false;
                    
                    // Hide loading section first
                    document.getElementById('loadingSection').classList.add('hidden');
                    
                    showUploadSuccess(result);
                    
                    // Small delay to ensure DOM updates, then switch to flashcards tab
                    setTimeout(() => {
                        showTab('flashcards'); // Switch to flashcards tab after successful generation
                        
                        // Automatically refresh the flashcard view
                        if (currentFlashcards && currentFlashcards.length > 0) {
                            loadFilters();
                            updateFlashcard();
                        }
                    }, 100);
                } else {
                    // Hide loading section on error too
                    document.getElementById('loadingSection').classList.add('hidden');
                    showUploadError(result.error);
                }
            } catch (error) {
                // Hide loading section on exception
                document.getElementById('loadingSection').classList.add('hidden');
                showUploadError('Failed to upload file: ' + error.message);
            } finally {
                // Re-enable file input and reset its value
                const fileInputElement = document.getElementById('fileInput');
                if (fileInputElement) {
                    fileInputElement.disabled = false;
                    fileInputElement.value = ''; // Reset file input to allow selecting the same file again
                }
                if (uploadArea) {
                    uploadArea.style.pointerEvents = '';
                    uploadArea.style.opacity = '';
                }
            }
        }

        function showUploadSuccess(result) {
            // Loading section is already hidden in the main flow
            const uploadResult = document.getElementById('uploadResult');
            uploadResult.innerHTML = `
                <div class="result correct">
                    ‚úÖ ${result.message}
                </div>
            `;
            uploadResult.classList.remove('hidden');
        }

        function showUploadError(error) {
            // Loading section is already hidden in the main flow
            showSection('uploadSection');
            const uploadResult = document.getElementById('uploadResult');
            uploadResult.innerHTML = `
                <div class="result incorrect">
                    ‚ùå ${error}
                </div>
            `;
            uploadResult.classList.remove('hidden');
        }

        // URL processing functionality
        async function processURL() {
            const urlInput = document.getElementById('urlInput');
            const urlBtn = document.getElementById('urlBtn');
            const urlResult = document.getElementById('urlResult');
            
            // Prevent multiple simultaneous requests
            if (urlBtn.disabled) {
                return;
            }
            
            const url = urlInput.value.trim();
            if (!url) {
                urlResult.innerHTML = `
                    <div class="result incorrect">
                        ‚ùå Please enter a valid URL
                    </div>
                `;
                urlResult.classList.remove('hidden');
                return;
            }

            // Validate URL format
            try {
                new URL(url);
            } catch (e) {
                urlResult.innerHTML = `
                    <div class="result incorrect">
                        ‚ùå Please enter a valid URL (must start with http:// or https://)
                    </div>
                `;
                urlResult.classList.remove('hidden');
                return;
            }

            urlBtn.disabled = true;
            urlBtn.textContent = 'üîÑ Processing...';
            urlInput.disabled = true;  // Also disable input during processing
            urlResult.innerHTML = `
                <div style="text-align: center; color: #666; padding: 20px;">
                    <div class="loading-spinner"></div>
                    <p>Extracting content from URL and generating flashcards...</p>
                    <p style="font-size: 14px; margin-top: 10px;">This may take a few moments.</p>
                </div>
            `;
            urlResult.classList.remove('hidden');

            console.log('Processing URL:', url);

            try {
                const response = await fetch('/generate-from-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    // If we can't parse JSON, create a generic error object
                    result = { 
                        detail: `Server error (${response.status}): ${response.statusText}`,
                        error: 'Failed to parse server response'
                    };
                }

                if (response.ok) {
                    currentFlashcards = result.flashcards;
                    currentSessionId = result.session_id; // Store the session ID
                    
                    // Reset any active study session since we have new flashcards
                    currentStudySessionId = null;
                    studySessionActive = false;
                    studySessionComplete = false;
                    studyResults = null;
                    showingResult = false;
                    
                    urlResult.innerHTML = `
                        <div class="result correct">
                            ‚úÖ Successfully generated ${result.flashcards.length} flashcards from URL!
                        </div>
                    `;
                    
                    // Small delay to ensure DOM updates, then switch to flashcards tab
                    setTimeout(() => {
                        showTab('flashcards'); // Switch to flashcards tab after successful generation
                        
                        // Automatically refresh the flashcard view
                        if (currentFlashcards && currentFlashcards.length > 0) {
                            loadFilters();
                            updateFlashcard();
                        }
                    }, 100);
                } else {
                    // More detailed error handling
                    let errorMessage = result.detail || result.error || result.message || `Server error (${response.status})`;
                    
                    // Check for specific API credit error
                    if (errorMessage.includes('credit balance is too low') || 
                        errorMessage.includes('Plans & Billing') ||
                        errorMessage.includes('purchase credits')) {
                        errorMessage = 'API credits exhausted. The service needs more credits to process requests.';
                    }
                    
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('Error processing URL:', error);
                let errorMessage = 'Failed to process URL';
                let helpText = 'Please check that the URL is accessible and contains readable content.';
                
                // Better error message extraction
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.detail) {
                    errorMessage = error.detail;
                } else if (error.error) {
                    errorMessage = error.error;
                }
                
                // Special handling for credit/API issues
                if (errorMessage.includes('API credits exhausted') || 
                    errorMessage.includes('credit balance') ||
                    errorMessage.includes('purchase credits')) {
                    helpText = 'The AI service requires credits to generate flashcards. Please contact the administrator to add more credits.';
                }
                
                urlResult.innerHTML = `
                    <div class="result incorrect">
                        ‚ùå Error: ${errorMessage}
                        <br><small>${helpText}</small>
                    </div>
                `;
            } finally {
                urlBtn.disabled = false;
                urlBtn.textContent = 'üöÄ Generate Flashcards';
                urlInput.disabled = false;  // Re-enable input
            }
        }

        function showSetupSection(flashcardCount) {
            // Store flashcards data and switch to study tab
            const flashcardInfo = document.getElementById('flashcardInfo');
            flashcardInfo.innerHTML = `
                <div style="text-align: center; padding: 15px; background: #f0f8ff; border-radius: 8px; margin-bottom: 20px;">
                    <span style="font-size: 18px;">‚úÖ</span>
                    <strong>Ready to study!</strong><br>
                    <span style="color: #666;">${flashcardCount} flashcards loaded</span>
                </div>
            `;
            
            // Update the study input max values - always based on full flashcard count
            // Study sessions are independent of flashcard tab filtering
            document.getElementById('numQuestions').max = flashcardCount;
            document.getElementById('numQuestions').value = Math.min(10, flashcardCount);
            
            // Load filters
            loadFilters();
            
            // Switch to study tab and show setup
            showTab('study');
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('studySessionSection').classList.add('hidden');
            document.getElementById('studyResultsSection').classList.add('hidden');
        }

        // Study mode functions for the study tab
        async function startStudySession() {
            // Study sessions always use the full set of flashcards (currentFlashcards),
            // not the filtered flashcards from the flashcard tab. This ensures that
            // filtering in the flashcard tab does not affect study sessions.
            console.log('Starting study session, currentSessionId:', currentSessionId);
            
            if (!currentSessionId) {
                alert('No flashcards session available. Please generate flashcards first.');
                return;
            }

            const numQuestions = parseInt(document.getElementById('numQuestions').value);
            console.log('Number of questions:', numQuestions);
            
            try {
                const requestBody = {
                    session_id: currentSessionId,
                    num_questions: numQuestions
                };
                
                const response = await fetch('/start_session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (response.ok) {
                    currentStudySessionId = result.study_session_id;
                    studySessionActive = true;
                    studySessionComplete = false;
                    studyResults = null;
                    showingResult = false;
                    
                    // Set the total questions count in the UI
                    const totalQuestionsSpan = document.getElementById('totalQuestions');
                    if (totalQuestionsSpan) {
                        totalQuestionsSpan.textContent = numQuestions;
                    }
                    
                    // Show the study session section
                    document.getElementById('setupSection').classList.add('hidden');
                    document.getElementById('studySessionSection').classList.remove('hidden');
                    document.getElementById('studyResultsSection').classList.add('hidden');
                    
                    // Load the first question
                    loadNextQuestion();
                } else {
                    if (result.detail && result.detail.includes('Session expired')) {
                        // Try to recreate the session automatically
                        const sessionRecreated = await recreateSessionIfNeeded();
                        if (sessionRecreated) {
                            // Retry starting the study session
                            await startStudySession();
                            return;
                        } else {
                            // Fallback to manual regeneration
                            if (confirm('Your session has expired (server was restarted). Would you like to regenerate your flashcards?')) {
                                currentSessionId = null;
                                currentFlashcards = [];
                                showTab('generate');
                            }
                        }
                    } else {
                        alert('Error starting study session: ' + (result.error || result.detail));
                    }
                }
            } catch (error) {
                alert('Failed to start study session: ' + error.message);
            }
        }

        async function loadNextQuestion(mode = 'normal') {
            console.log('Loading next question, currentStudySessionId:', currentStudySessionId);
            
            try {
                const response = await fetch('/get_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        study_session_id: currentStudySessionId
                    })
                });

                const result = await response.json();
                console.log('Get question response:', result);

                if (response.ok) {
                    if (result.complete) {
                        showFinalResults(result);
                    } else {
                        currentQuestionData = result;
                        displayQuestion(result, mode);
                        showingResult = false;
                    }
                } else {
                    console.error('Error response:', result);
                    alert('Error: ' + (result.error || result.detail));
                }
            } catch (error) {
                console.error('Failed to load question:', error);
                alert('Failed to load question: ' + error.message);
            }
        }

        function displayQuestion(questionData, mode = 'normal') {
            // Update progress
            const progressBar = document.getElementById('progressBar');
            const currentQuestionNum = document.getElementById('currentQuestionNum');
            const totalQuestionsSpan = document.getElementById('totalQuestions');
            const currentQuestion = document.getElementById('currentQuestion');
            const answerInput = document.getElementById('answerInput');
            const answerFeedback = document.getElementById('answerFeedback');

            if (progressBar) {
                const progress = (questionData.question_number / questionData.total_questions) * 100;
                progressBar.style.width = progress + '%';
            }
            
            if (currentQuestionNum) currentQuestionNum.textContent = questionData.question_number;
            if (totalQuestionsSpan) totalQuestionsSpan.textContent = questionData.total_questions;
            if (currentQuestion) currentQuestion.textContent = questionData.question;
            
            // Reset input and feedback
            if (answerInput) {
                answerInput.value = '';
                answerInput.disabled = false;
            }
            if (answerFeedback) {
                answerFeedback.classList.add('hidden');
            }
        }

        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) {
                alert('Please enter an answer');
                return;
            }

            if (showingResult) {
                nextQuestion();
                return;
            }

            try {
                const response = await fetch('/submit_answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        study_session_id: currentStudySessionId,
                        answer: answer
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showResult(result);
                    showingResult = true;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Failed to submit answer: ' + error.message);
            }
        }

        function showResult(result, mode = 'normal') {
            // Use the answerFeedback element for showing results in study session
            const resultContainer = document.getElementById('answerFeedback');
            const answerInput = document.getElementById('answerInput');
            
            let resultHTML = '';
            if (result.skipped) {
                resultHTML = `
                    <div class="result" style="background: #fef5e7; color: #744210; border: 2px solid #ed8936;">
                        ‚è≠Ô∏è Question Skipped
                    </div>
                `;
            } else {
                resultHTML = `
                    <div class="result ${result.correct ? 'correct' : 'incorrect'}">
                        ${result.correct ? '‚úÖ Correct!' : '‚ùå Incorrect'}
                    </div>
                `;
            }
            
            resultHTML += `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-top: 10px; color: #2d3748;">
                    <strong>üìñ Correct Answer:</strong> ${result.correct_answer}
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn" onclick="loadNextQuestion()">Next Question</button>
                </div>
            `;
            
            if (resultContainer) {
                resultContainer.innerHTML = resultHTML;
                resultContainer.classList.remove('hidden');
            }
            
            if (answerInput) {
                answerInput.disabled = true;
            }
        }

        async function getHint() {
            try {
                const response = await fetch('/get_hint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        study_session_id: currentStudySessionId
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    const hintContainer = document.getElementById('hintContainer');
                    hintContainer.innerHTML = `
                        <div class="hint">
                            <strong>üí° Hint:</strong> ${result.hint}
                        </div>
                    `;
                    hintContainer.classList.remove('hidden');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Failed to get hint: ' + error.message);
            }
        }

        function skipQuestion() {
            // Simulate incorrect answer to move to next question
            fetch('/submit_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    study_session_id: currentStudySessionId,
                    answer: 'SKIPPED'
                })
            }).then(response => response.json())
              .then(result => {
                  const resultContainer = document.getElementById('answerFeedback');
                  resultContainer.innerHTML = `
                      <div class="result" style="background: #fef5e7; color: #744210; border-color: #ed8936;">
                          ‚è≠Ô∏è Question Skipped
                      </div>
                      <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-top: 10px; color: #2d3748;">
                          <strong>üìñ Correct Answer:</strong> ${result.correct_answer}
                      </div>
                      <div style="text-align: center; margin-top: 15px;">
                          <button class="btn" onclick="loadNextQuestion()">Next Question</button>
                      </div>
                  `;
                  resultContainer.classList.remove('hidden');
                  
                  document.getElementById('answerInput').disabled = true;
                  showingResult = true;
              });
        }

        function nextQuestion() {
            loadNextQuestion();
        }

        function showFinalResults(results) {
            const finalResults = document.getElementById('finalResults');
            
            let emoji = '';
            let message = '';
            if (results.percentage >= 90) {
                emoji = 'üåü';
                message = 'Excellent work! You\'ve mastered this material!';
            } else if (results.percentage >= 80) {
                emoji = 'üëè';
                message = 'Great job! You have a strong understanding!';
            } else if (results.percentage >= 70) {
                emoji = 'üëç';
                message = 'Good work! Keep studying to improve!';
            } else if (results.percentage >= 60) {
                emoji = 'üìö';
                message = 'You\'re getting there! Review the material and try again!';
            } else {
                emoji = 'üí™';
                message = 'Keep studying! Practice makes perfect!';
            }

            finalResults.innerHTML = `
                <div class="final-score">
                    <h2>üéâ Study Session Complete!</h2>
                    <div style="font-size: 2em; margin: 20px 0;">
                        ${results.final_score}/${results.total_questions}
                    </div>
                    <div style="font-size: 1.5em; margin: 10px 0;">
                        ${results.percentage.toFixed(1)}%
                    </div>
                    <div style="font-size: 1.2em; margin-top: 20px;">
                        ${emoji} ${message}
                    </div>
                </div>
            `;
            
            // Hide study session section and show results
            document.getElementById('studySessionSection').classList.add('hidden');
            document.getElementById('studyResultsSection').classList.remove('hidden');
            document.getElementById('studyResults').innerHTML = finalResults.innerHTML;
        }

        function startNewStudySession() {
            // Reset study session state
            currentStudySessionId = null;
            studySessionActive = false;
            studySessionComplete = false;
            studyResults = null;
            showingResult = false;
            
            // Show setup section again
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('studySessionSection').classList.add('hidden');
            document.getElementById('studyResultsSection').classList.add('hidden');
        }

        function endStudySession() {
            if (confirm('Are you sure you want to end this study session?')) {
                // Show results section if we have results, otherwise go back to setup
                document.getElementById('studySessionSection').classList.add('hidden');
                document.getElementById('setupSection').classList.remove('hidden');
            }
        }

        // Recreate session function for when session expires
        async function recreateSessionIfNeeded() {
            if (!currentFlashcards || currentFlashcards.length === 0) {
                return false;
            }
            
            try {
                // Try to recreate session with current flashcards
                const formData = new FormData();
                const flashcardsBlob = new Blob([JSON.stringify(currentFlashcards)], { type: 'application/json' });
                formData.append('file', flashcardsBlob, 'flashcards.json');
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (response.ok) {
                    currentSessionId = result.session_id;
                    return true;
                }
            } catch (error) {
                console.error('Failed to recreate session:', error);
            }
            return false;
        }

        function startOver() {
            location.reload();
        }

        // Flashcard browsing functionality  
        let isCardFlipped = false;
        
        function loadFilters() {
            if (!currentFlashcards || currentFlashcards.length === 0) return;
            
            // Show filters section
            const filtersSection = document.getElementById('filtersSection');
            if (filtersSection) {
                filtersSection.classList.remove('hidden');
            }
            
            // Extract unique categories, difficulties, and types
            const categories = [...new Set(currentFlashcards.map(card => card.category || 'General'))];
            const difficulties = [...new Set(currentFlashcards.map(card => card.difficulty || 'Medium'))];
            const types = [...new Set(currentFlashcards.map(card => card.type || 'question_answer'))];
            
            // Populate category filter
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                categoryFilter.innerHTML = '<option value="all">All Categories</option>';
                categories.forEach(category => {
                    categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
                });
            }
            
            // Populate difficulty filter
            const difficultyFilter = document.getElementById('difficultyFilter');
            if (difficultyFilter) {
                difficultyFilter.innerHTML = '<option value="all">All Difficulties</option>';
                difficulties.forEach(difficulty => {
                    difficultyFilter.innerHTML += `<option value="${difficulty}">${difficulty}</option>`;
                });
            }
            
            // Populate type filter
            const typeFilter = document.getElementById('typeFilter');
            if (typeFilter) {
                typeFilter.innerHTML = '<option value="all">All Types</option>';
                types.forEach(type => {
                    const displayName = type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    typeFilter.innerHTML += `<option value="${type}">${displayName}</option>`;
                });
            }
            
            // Apply initial filters
            applyFilters();
        }
        
        function applyFilters() {
            if (!currentFlashcards || currentFlashcards.length === 0) return;
            
            const categoryFilter = document.getElementById('categoryFilter');
            const difficultyFilter = document.getElementById('difficultyFilter');
            const typeFilter = document.getElementById('typeFilter');
            
            if (!categoryFilter || !difficultyFilter || !typeFilter) return;
            
            filteredFlashcards = currentFlashcards.filter(card => {
                const categoryMatch = categoryFilter.value === 'all' || (card.category || 'General') === categoryFilter.value;
                const difficultyMatch = difficultyFilter.value === 'all' || (card.difficulty || 'Medium') === difficultyFilter.value;
                const typeMatch = typeFilter.value === 'all' || (card.type || 'question_answer') === typeFilter.value;
                
                return categoryMatch && difficultyMatch && typeMatch;
            });
            
            // Update filter results display
            const filterResults = document.getElementById('filterResults');
            if (filterResults) {
                filterResults.textContent = `Showing ${filteredFlashcards.length} of ${currentFlashcards.length} flashcards`;
            }
            
            // Reset to first card and update display
            currentCardIndex = 0;
            updateFlashcard();
        }
        
        function showFlashcardsView() {
            if (!currentFlashcards || currentFlashcards.length === 0) {
                alert('No flashcards available. Please generate some first.');
                return;
            }
            
            showTab('flashcards');
            currentCardIndex = 0;
            isCardFlipped = false;
            
            updateFlashcard();
        }

        function updateFlashcard() {
            const cardsToUse = filteredFlashcards.length > 0 ? filteredFlashcards : currentFlashcards;
            
            if (!cardsToUse || cardsToUse.length === 0) {
                // Show message when no flashcards available
                const cardQuestion = document.getElementById('cardQuestion');
                const cardAnswer = document.getElementById('cardAnswer');
                const cardCounter = document.getElementById('cardCounter');
                
                if (cardQuestion) cardQuestion.textContent = 'Generate flashcards first to browse them';
                if (cardAnswer) cardAnswer.textContent = 'Answer will appear here';
                if (cardCounter) cardCounter.textContent = '0 / 0';
                return;
            }
            
            // Ensure currentCardIndex is within bounds
            if (currentCardIndex >= cardsToUse.length) {
                currentCardIndex = 0;
            }
            
            const card = cardsToUse[currentCardIndex];
            const flashcard = document.getElementById('currentFlashcard');
            const cardQuestion = document.getElementById('cardQuestion');
            const cardAnswer = document.getElementById('cardAnswer');
            const cardCounter = document.getElementById('cardCounter');
            const cardType = document.getElementById('cardType');

            // Reset flip state
            isCardFlipped = false;
            if (flashcard) {
                flashcard.classList.remove('flipped');
            }

            // Update content based on card type
            if (card.type === 'question_answer') {
                if (cardType) cardType.textContent = 'Question';
                if (cardQuestion) cardQuestion.textContent = card.question;
                if (cardAnswer) cardAnswer.textContent = card.answer;
            } else if (card.type === 'vocabulary') {
                if (cardType) cardType.textContent = 'Term';
                if (cardQuestion) cardQuestion.textContent = card.term;
                if (cardAnswer) cardAnswer.textContent = card.definition;
            } else if (card.type === 'fact') {
                if (cardType) cardType.textContent = 'Fact';
                if (cardQuestion) cardQuestion.textContent = card.prompt;
                if (cardAnswer) cardAnswer.textContent = card.content;
            }

            // Update counter
            if (cardCounter) {
                cardCounter.textContent = `${currentCardIndex + 1} / ${cardsToUse.length}`;
            }

            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) prevBtn.disabled = currentCardIndex === 0;
            if (nextBtn) nextBtn.disabled = currentCardIndex === cardsToUse.length - 1;
        }

        function previousCard() {
            const cardsToUse = filteredFlashcards.length > 0 ? filteredFlashcards : currentFlashcards;
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateFlashcard();
            }
        }

        function nextCard() {
            const cardsToUse = filteredFlashcards.length > 0 ? filteredFlashcards : currentFlashcards;
            if (currentCardIndex < cardsToUse.length - 1) {
                currentCardIndex++;
                updateFlashcard();
            }
        }

        function flipCard() {
            const flashcard = document.getElementById('currentFlashcard');
            isCardFlipped = !isCardFlipped;
            
            if (isCardFlipped) {
                flashcard.classList.add('flipped');
            } else {
                flashcard.classList.remove('flipped');
            }
        }

        // Study mode functions for the study tab
        async function submitStudyAnswer() {
            const answerInput = document.getElementById('studyAnswerInput');
            const userAnswer = answerInput.value.trim();
            
            if (!userAnswer) {
                alert('Please enter an answer');
                return;
            }

            if (!currentStudySessionId) {
                alert('No active study session');
                return;
            }

            try {
                const response = await fetch('/submit_answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        study_session_id: currentStudySessionId,
                        answer: userAnswer
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showResult(result, 'study');
                    showingResult = true;
                } else {
                    throw new Error(result.detail || 'Failed to submit answer');
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('Failed to submit answer: ' + error.message);
            }
        }

        async function getStudyHint() {
            try {
                const response = await fetch('/get_hint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        study_session_id: currentStudySessionId
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    const hintContainer = document.getElementById('studyHintContainer');
                    hintContainer.innerHTML = `
                        <div class="hint">
                            <strong>üí° Hint:</strong> ${result.hint}
                        </div>
                    `;
                    hintContainer.classList.remove('hidden');
                } else {
                    alert('Error: ' + (result.error || result.detail));
                }
            } catch (error) {
                alert('Failed to get hint: ' + error.message);
            }
        }

        function skipStudyQuestion() {
            // Simulate incorrect answer to move to next question
            fetch('/submit_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    study_session_id: currentStudySessionId,
                    answer: 'SKIPPED'
                })
            }).then(response => response.json())
              .then(result => {
                  showResult({
                      ...result,
                      correct: false,
                      skipped: true
                  }, 'study');
                  showingResult = true;
              })
              .catch(error => {
                  console.error('Error skipping question:', error);
                  alert('Failed to skip question: ' + error.message);
              });
        }

        // Enhanced answer submission for normal mode
        async function submitAnswer() {
            const answerInput = document.getElementById('answerInput');
            const userAnswer = answerInput.value.trim();
            
            if (!userAnswer) {
                alert('Please enter an answer');
                return;
            }

            if (!currentStudySessionId) {
                alert('No active study session');
                return;
            }

            if (showingResult) {
                nextQuestion();
                return;
            }

            try {
                const response = await fetch('/submit_answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        study_session_id: currentStudySessionId,
                        answer: userAnswer
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showResult(result, 'normal');
                    showingResult = true;
                } else {
                    throw new Error(result.detail || 'Failed to submit answer');
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('Failed to submit answer: ' + error.message);
            }
        }

        function showSection(sectionId) {
            // Don't hide upload and URL sections - keep them always visible
            const sectionsToHide = ['setupSection', 'studySection', 'resultsSection', 'loadingSection'];
            
            if (sectionId === 'flashcardsViewSection') {
                // When showing flashcards view, hide only the non-input sections
                sectionsToHide.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('hidden');
                    }
                });
                // Show the flashcards view
                const flashcardsElement = document.getElementById('flashcardsViewSection');
                if (flashcardsElement) {
                    flashcardsElement.classList.remove('hidden');
                }
            } else {
                // For other sections, hide everything except upload and URL sections
                const allSections = ['setupSection', 'studySection', 'resultsSection', 'loadingSection', 'flashcardsViewSection'];
                allSections.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('hidden');
                    }
                });
                // Show the target section
                const targetElement = document.getElementById(sectionId);
                if (targetElement) {
                    targetElement.classList.remove('hidden');
                }
            }
        }

        // Function to recreate session if it was lost (e.g., due to server restart)
        async function recreateSessionIfNeeded() {
            if (!currentFlashcards || currentFlashcards.length === 0) {
                return false;
            }
            
            try {
                // Try to create a new session with the current flashcards
                const response = await fetch('/create_session_from_flashcards', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        flashcards: currentFlashcards
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentSessionId = result.session_id;
                    console.log('‚úÖ Successfully recreated session:', currentSessionId);
                    return true;
                }
            } catch (error) {
                console.error('Failed to recreate session:', error);
            }
            
            return false;
        }

        // Check and recreate session on page load
        window.addEventListener('load', async () => {
            // Try to recreate session if it was lost
            const sessionRestored = await recreateSessionIfNeeded();
            if (sessionRestored) {
                alert('Your previous session has been restored. You can continue studying now.');
                showTab('study');
            } else {
                // No session to restore, keep showing generate tab
                showTab('generate');
            }
        });

        // PWA Initialization Function
        function initializePWA() {
            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('‚úÖ SW registered: ', registration);
                        
                        // Listen for service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // New update available
                                        showMessage('üîÑ App update available! Refreshing...', 'info');
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 2000);
                                    }
                                });
                            }
                        });
                    })
                    .catch((registrationError) => {
                        console.log('‚ùå SW registration failed: ', registrationError);
                    });
                
                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'APP_UPDATED') {
                        showMessage('‚ú® App updated successfully!', 'success');
                    }
                });
                
                // Register for background sync if available
                if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                    navigator.serviceWorker.ready.then((registration) => {
                        registration.sync.register('background-sync');
                    });
                }
            }
            
            // PWA Install Prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('üì± PWA install prompt available');
                e.preventDefault();
                deferredPrompt = e;
                showInstallPrompt();
            });
            
            // Handle successful app installation
            window.addEventListener('appinstalled', (evt) => {
                console.log('üéâ App was installed successfully');
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.remove();
                }
            });
        }

        // PWA Install Prompt and related functions
        function showInstallPrompt() {
            // Create install button if it doesn't exist
            if (!document.getElementById('installBtn')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'installBtn';
                installBtn.innerHTML = 'üì± Install App';
                installBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #667eea;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                    z-index: 1000;
                    transition: all 0.3s ease;
                `;
                installBtn.onmouseover = () => installBtn.style.background = '#5a67d8';
                installBtn.onmouseout = () => installBtn.style.background = '#667eea';
                installBtn.onclick = installApp;
                document.body.appendChild(installBtn);
            }
        }

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`üì± User response: ${outcome}`);
                deferredPrompt = null;
                
                // Hide install button
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.remove();
                }
            }
        }

        // Tab Navigation Functions
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to the correct tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tabName.toLowerCase()) ||
                    (tabName === 'upload' && btn.textContent.includes('Upload')) ||
                    (tabName === 'study' && btn.textContent.includes('Study')) ||
                    (tabName === 'browse' && btn.textContent.includes('Browse'))) {
                    btn.classList.add('active');
                }
            });
            
            // Auto-switch to study tab if setup is complete
            if (tabName === 'study' && currentFlashcards.length === 0) {
                showTab('upload');
                showMessage('Please upload study material first!', 'error');
                return;
            }
        }

        // Restart App Function
        async function restartApp() {
            if (confirm('Are you sure you want to restart the app? This will clear all flashcards and study data.')) {
                try {
                    const response = await fetch('/restart', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ confirm: true })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Reset all UI state
                        currentFlashcards = [];
                        filteredFlashcards = [];
                        currentSessionId = null;
                        currentStudySessionId = null;
                        
                        // Reset UI
                        showTab('upload');
                        document.getElementById('setupSection').classList.add('hidden');
                        document.getElementById('studySessionSection').classList.add('hidden');
                        document.getElementById('studyResultsSection').classList.add('hidden');
                        document.getElementById('filtersSection').classList.add('hidden');
                        
                        // Clear upload results
                        document.getElementById('uploadResult').innerHTML = '';
                        document.getElementById('uploadResult').classList.add('hidden');
                        document.getElementById('urlResult').innerHTML = '';
                        document.getElementById('urlResult').classList.add('hidden');
                        
                        showMessage('App restarted successfully!', 'success');
                    } else {
                        showMessage('Failed to restart app', 'error');
                    }
                } catch (error) {
                    console.error('Error restarting app:', error);
                    showMessage('Error restarting app', 'error');
                }
            }
        }

        // Filter Functions
        async function loadFilters() {
            if (!currentSessionId) return;
            
            try {
                const response = await fetch(`/get_filters?session_id=${currentSessionId}`);
                const data = await response.json();
                
                // Populate filter dropdowns
                populateFilterDropdown('categoryFilter', data.categories);
                populateFilterDropdown('difficultyFilter', data.difficulties);
                populateFilterDropdown('typeFilter', data.types);
                
                // Show filters section
                document.getElementById('filtersSection').classList.remove('hidden');
                
                // Initialize with all flashcards
                filteredFlashcards = [...currentFlashcards];
                updateFilterResults();
                
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }

        function populateFilterDropdown(selectId, options) {
            const select = document.getElementById(selectId);
            // Keep the "All" option and add specific options
            const currentOptions = Array.from(select.options).slice(1); // Remove existing options except "All"
            currentOptions.forEach(option => option.remove());
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option.charAt(0).toUpperCase() + option.slice(1);
                select.appendChild(optionElement);
            });
        }

        async function applyFilters() {
            if (!currentSessionId) return;
            
            currentFilters = {
                category: document.getElementById('categoryFilter').value,
                difficulty: document.getElementById('difficultyFilter').value,
                type: document.getElementById('typeFilter').value
            };
            
            try {
                const response = await fetch('/filter_flashcards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        filters: currentFilters
                    })
                });
                
                const data = await response.json();
                filteredFlashcards = data.flashcards;
                updateFilterResults();
                
                // Study tab should always use the full set of flashcards, not filtered ones
                // The numQuestions input should be based on currentFlashcards.length, not filteredFlashcards.length
                // This ensures that filtering in the flashcard tab does not affect the study session
                
            } catch (error) {
                console.error('Error applying filters:', error);
                showMessage('Error applying filters', 'error');
            }
        }

        function updateFilterResults() {
            const resultsDiv = document.getElementById('filterResults');
            const total = currentFlashcards.length;
            const filtered = filteredFlashcards.length;
            resultsDiv.textContent = `Showing ${filtered} of ${total} flashcards`;
        }
    </script>

    <!-- Footer -->
    <div class="footer">
        <p>Created with ‚ù§Ô∏è by <a href="#" target="_blank">Isaac Mineo</a> ¬© 2025</p>
        <p>Quizium - AI-Powered Study Assistant</p>
    </div>
</body>
</html>
